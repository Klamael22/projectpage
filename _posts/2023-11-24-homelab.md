---
title: "Homelab Project"
categories:
  - Blog
tags:
  - Post Formats
  - readability
  - standard
toc: true
toc-label: Table of Contents
---

# Project Scope:
This project will consist of creating a virtualized homelab in Proxmox. As a jumping off point, this lab will be comprised of pfSense, Windows Server, and a few Windows 10 clients. I have already created several homelabs with Proxmox, but have not documented the process before. My primary goal is to gain hands-on experience with networking, firewalls, and Active Directory. My secondary goals are to utilize this lab to practice offensive and defensive security.

# Infrastructure:
This homelab will be constructed using what I have available:

## Dell Precision T3610: 
This computer was dropped off at a previous job to be recycled. After disposing of the drives, I put in some new HDDs, stuffed it full of RAM and took it home for homelab purposes.

### Specs:
- Xeon E5-1620 v2
- 32GB RAM
- 1TB HDD x 2
- One on-board NIC
- Intel 4-port 10Gb NIC

## Linksys MR3700 Series Smart Wi-Fi Router
Again, nothing crazy here. This is the router that was in place when I moved in.

# Hypervisor:
For every homelab project I've created so far, I've used Proxmox. It is pretty straight forward to get up and running, very flexible, and just like the rest of my lab (minus a monitor, keyboard, and cables) is free.

## Proxmox System Info:
There's plenty of resources online regarding the installation of Proxmox. The relevant specifications of my environment are as follows:
- Proxmox VE v 8.0.3
- Network: 

|Bridge|Interface|Description|
|---|---|---|
|vmbr0|enp0s25|Proxmox interface|
|vmbr1|enp3s0f3|pfSense WAN interface|
|vmbr2|N/A|pfSense LAN interface|
|vmbr3|N/A|pfSense OPT1 interface|

`vmbr0` and `vmbr1` are the only two linux bridges that are assigned a physical port for the time being.

# The VMs:
This section will serve as reference to VM creation and initial configuration.

## pfSense
### VM creation
Defaults used, unless stated otherwise.
- General:
	- VM ID: 100
	- Name: pfSense
- OS:
	- ISO image: pfSense-CE-2.7.0
	- Guest OS:
		- Type: Linux
		- Version: 6.x - 2.6 Kernel
- System:
	- Graphic card: Default
	- Machine: Default (i440fx)
	- BIOS: Default (SeaBIOS)
	- SCSI Controller: VirtIO SCSI single
	- Qemu Agent: disabled
	- Add TPM: disabled
- Disks:
	- Bus/Device: SCSI
	- Storage: local-lvm
	- Disk size: 32 GB
	- Cache: Default (No cache)
	- Discard: disabled
	- IO thread: enabled
- CPU:
	- Sockets: 1
	- Cores: 1
	- Type: kvm64
	- CPU units: 1024
- Memory:
	- Memory: 2048 MB
- Network:
	- Bridge: vmbr1
	- Model: VirtIO (paravirtualized)
- Confirm:
	- Start after created: disabled

#### Before Starting the VM
After creating the VM we will need to add several network adapters.
- Click the newly created VM
- Click Hardware
- Add > Network Device
	- vmbr2 (ManagementNetwork)
	- vmbr3 (VictimNetwork)

Now the VM is configured, and we are ready to start the installation.

### Installing pfSense
- Start the VM
- Welcome Screen:
	- Install
- Partitioning:
	- Auto (ZFS)
- ZFS Configuration:
	- Leave defaults selected
	- Install
	- stripe
- Complete:
	- Reboot

### Initial Setup
- `Do VLANs need to be set up first?`
	- `n`
- `Enter the WAN interface`
	- `vtnet0`
- `Enter the LAN interface`
	- `vtnet1`
- `Enter the Optional 1 interface`
	- `vtnet2`
- Type 2, to set interface(s) IP address
	- 1 - WAN
		- `Configure IPv4 address WAN interface via DHCP?`
			- n
		- `Enter the new WAN IPv4 address`
			- `192.168.1.3`
		- `Enter the WAN IPv4 subnet bit count`
			- 24
		- `For a WAN, enter the new WAN IPv4 upstream gateway address`
			- 192.168.1.1
			- Set as default gateway
		- Do not configure IPv6 address
		- Do not enable DHCP server on WAN
		- Revert to HTTP as the webConfigurator protocol
	- 2 - LAN
		- `Configure IPv4 address WAN interface via DHCP?`
			- n
		- `Enter the new LAN IPv4 address`
			- `10.0.0.1`
		- `Enter the new LAN IPv4 subnet bit count`
			- 26
		- Press enter for no upstream gateway address
		- Do not configure IPv6 address
		- Enabled DHCP server
		- DHCP range:
			- 10.0.0.10 - 10.0.0.62
	-  3 - OPT
		- `Configure IPv4 address WAN interface via DHCP?`
			- n
		- `Enter the new LAN IPv4 address`
			- `10.0.0.65`
		- `Enter the new LAN IPv4 subnet bit count`
			- 26
		- Press enter for no upstream gateway address
		- Do not configure IPv6 address
		- Enabled DHCP server
		- DHCP range:
			- 10.0.0.74 - 10.0.0.126

## Windows Server 2019
### VM Creation
Resource used:
https://pve.proxmox.com/wiki/Windows_2019_guest_best_practices

Defaults used, unless stated otherwise.
- General:
	- VM ID: 101
	- Name: WinDC
- OS:
	- ISO image: Windows Server 2019
	- Guest OS:
		- Type: Microsoft Windows
		- Version: 10/2016/2019
- System:
	- Graphic card: Default
	- Machine: Default (i440fx)
	- BIOS: Default (SeaBIOS)
	- SCSI Controller: VirtIO SCSI
	- Qemu Agent: enabled
	- Add TPM: disabled
- Disks:
	- Bus/Device: SCSI
	- Storage: local-lvm
	- Disk size: 64 GB
	- Cache: Write back
	- Discard: enabled
	- IO thread: enabled
- CPU:
	- Sockets: 1
	- Cores: 1
	- Type: kvm64
	- CPU units: 1024
- Memory:
	- Memory: 4096 MB
- Network:
	- Bridge: vmbr2
	- Model: VirtIO (paravirtualized)
- Confirm:
	- Start after created: disabled

#### Before starting the VM
Before we start the VM and install Windows Server, we will need to add a second disk drive for virtIO drivers.
- Click newly created VM
- Click Hardware tab
- Add > CD/DVD Drive
	- ISO image: virtio-win.iso

### Installing Windows Server
- Start VM and let the Windows installer load
- Select Windows Server 2019 Standard Evaluation (Desktop Experience)
- Accept license terms
- Custom: Install Windows only
- Load drivers:
	- Browse
		- CD Drive: virtio-win-0.1.240 > vioscsi > 2k19 > amd64
		- CD Drive: virtio-win-0.1.240 > Balloon > 2k19 > amd64
		- CD Drive: virtio-win-0.1.240 > NetKVM > 2k19 > amd64
- Select Drive 0 Unallocated Space > Next

After installation create a password for `Administrator` and sign in.

### Setting up Active Directory
Before installing any clients, let's install AD and setup a domain for them to join. In the past I have install ADDS through the Server Manager interface, but have opted to try installing with Powershell this time.

#### Setting Static IP
First I'll set a static IP for Windows Server.
- `> Get-NetIPInterface`
	- `ifIndex: 6`
- `> Set-NetIPAddress -InterfaceIndex 6 IPAddress 10.0.0.2 -PrefixLength 26`

#### Installing Active Directory Domain Services
- `> Add-WindowsFeature AD-Domain-Services`

#### Create a new AD forest and domain,  Install DNS, and promote to Domain Controller
- `Install-ADDSForest -DomainName someorg.local -InstallDNS`
- Enter `SafeModeAdministratorPassword`
- Type `A` to configure this server as a domain controller and restart when complete.

#### Renaming Domain Controller
AFter promoting to DC, I realized that I had not renamed the machine to something more descriptive, and easy to remember. I understand that renaming the DC would be a more sensitive procedure if I had already created domain accounts, so figured this would be as good of a time as any to learn the proper way to do this!
- `> netdom computername WIN-B41NG584K3T.someorg.local /add:domcon.someorg.local`
- `> netdome computername WIN-B41NG584K3T.someorg.local /makeprimary:domcon.someorg.local`
- reboot computer
- `> netdom computername domcon.someorg.local /remove:WIN-B41NG584K3T.someorg.local`

#### Configuring DNS Forwarder
I will be trying to have my lab resemble an enterprise setting as much as possible, and so will be using the AD DNS server for all assets. For simplicity's sake I'm just setting up forwarders on the DC to Google's DNS.

Open DNS application.
- Right-click DOMCON > Properties
	- Forwarders > Edit
        - 8.8.8.8
		- 8.8.4.4

## Windows 10 Client
### VM Creation
Resource:
https://pve.proxmox.com/wiki/Windows_10_guest_best_practices

Defaults used, unless stated otherwise.
- General:
	- VM ID: 201
	- Name: WinUser1
- OS:
	- ISO image: Windows 10 Enterprise
	- Guest OS:
		- Type: Microsoft Windows
		- Version: 10/2016/2019
- System:
	- Graphic card: Default
	- Machine: Default (i440fx)
	- BIOS: Default (SeaBIOS)
	- SCSI Controller: VirtIO SCSI
	- Qemu Agent: enabled
	- Add TPM: disabled
- Disks:
	- Bus/Device: SCSI
	- Storage: Clients
	- Disk size: 64 GB
	- Cache: Write back
	- Discard: enabled
	- IO thread: enabled
- CPU:
	- Sockets: 1
	- Cores: 1
	- Type: kvm64
	- CPU units: 1024
- Memory:
	- Memory: 4096 MB
- Network:
	- Bridge: vmbr3
	- Model: VirtIO (paravirtualized)
- Confirm:
	- Start after created: disabled

#### Before starting the VM
Before we start the VM and install Windows 10, we will need to add a second disk drive for virtIO drivers.
- Click newly created VM
- Click Hardware tab
- Add > CD/DVD Drive
	- ISO image: virtio-win.iso

### Installing Windows 10
- Start VM and let the Windows installer load
- Accept license terms
- Custom: Install Windows only
- Load drivers:
	- Browse
		- CD Drive: virtio-win-0.1.240 > vioscsi > w10 > amd64
		- CD Drive: virtio-win-0.1.240 > Balloon >w10 > amd64
		- CD Drive: virtio-win-0.1.240 > NetKVM > w10 > amd64
- Select Drive 0 Unallocated Space > Next

### Setup
Click through the location, and keyboard layout 

Domain join, instead
Name: Ben Horne
Password: ********

# pfSense Setup via webConfigurator
Now that we have pfSense, AD, and a client, let's access pfSense webConfigurator via browser from the DC, and run through the setup wizard. 

General Information
- Hostname: pfSense
- Domain: home.arpa
- Primary DNS Server: 10.0.0.2
- Allow DNS to be overridden: disable

Set time zone.

Configure WAN Interface
- Block RFC1918 Private Networks
- Block bogon networks

When setting up pfSense, the LAN interface will automatically generate firewall rules for accessing the internet. We will need to create a similar rule for the OPT1 interface.

Navigate to Firewall > Rules > OPT1
- Create:
  - Action: Pass
  - Interface: OPT1
  - Address Family: IPv4
  - Protocol: Any
  - Source: OPT1 net
  - Destination: Any